<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Light Theme Color -->
    <meta name="theme-color" content="#ffffff">
    <!-- Dark Theme Color -->
    <meta name="theme-color" content="#000000">

    <!-- Website Info  -->
    <title>MANYANTRA : Editor</title>
    <meta name="author" content="manyantra.com">
    <meta name="description" content="Write your article !">
    <meta name="keywords" content="read article, write article, share article">
    <!-- Website Sharable Link Info  -->
    <meta property="og:title" content="MANYANTRA : Editor">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.manyantra.com/editor">
    <meta property="og:image" content="https://www.manyantra.com/app_cover.png">
    <meta property="og:description" content="Write your article.">

    <!-- Website Favicon Icon -->
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="editor.css">


</head>

<body>


    <div class="editor-container">

        <!-- title -->
        <div class="editor-section">
            <label for="book-title" class="editor-label" id="label-title"></label>
            <div class="editor-title" contenteditable="true" id="book-title"></div>
        </div>


        <!-- icon -->
        <div class="editor-section">
            <label for="book-cover" class="editor-label" id="label-icon"></label>
            <input type="file" id="book-cover" accept="image/*" onchange="handleCoverPhoto(event)">
            <div class="editor-preview" id="cover-preview"></div>
        </div>


        <!-- text -->
        <div class="editor-section">
            <label for="editor" class="editor-label" id="label-text"></label>
            <div class="format-buttons">
                <input type="color" onchange="changeTextColor(this.value)">
                <select onchange="changeHeading(this.value)">
                    <option value="h1">Heading 1</option>
                    <option value="h2">Heading 2</option>
                    <option value="h3">Heading 3</option>
                </select>
                <select onchange="changeTextSize(this.value)">
                    <option value="2">Normal</option>
                    <option value="1">Small</option>
                    <option value="3">Large</option>
                </select>
                <select onchange="changeFont(this.value)">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Georgia">Georgia</option>
                </select>
                <button onclick="execCommand('bold')"><b>B</b></button>
                <button onclick="execCommand('italic')"><i>I</i></button>
                <button onclick="execCommand('underline')"><u>U</u></button>
                <button onclick="execCommand('justifyLeft')">Left</button>
                <button onclick="execCommand('justifyCenter')">Center</button>
                <button onclick="execCommand('justifyRight')">Right</button>
                <button onclick="execCommand('insertOrderedList')">OL</button>
                <button onclick="execCommand('insertUnorderedList')">UL</button>
                <button onclick="insertLink()">Link</button>
                <button onclick="insertImage()">Image</button>
                <button onclick="insertHorizontalRule()">Line</button>
                <button onclick="undo()">↩</button>
                <button onclick="redo()">↪</button>
            </div>
            <div class="editor-text" contenteditable="true" id="editor" onkeyup="checkFirstText()"></div>
        </div>


        <!-- content_type -->
        <div class="editor-section">
            <label for="book-content-type" class="editor-label" id="label-content-type"></label>
            <select id="book-content-type">
                <option value="New">New</option>
            </select>
        </div>

        <button class="preview-button" onclick="preview()">Preview</button>


    </div>

    <div id="booksGrid" class="grid-container"></div>


    <button class="sign-out-button">Sign out</button>


    <script>

        function setupTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                updateStatusBarColor('#000000');
            } else {
                updateStatusBarColor('#ffffff');
            }
        }

        function updateStatusBarColor(color) {
            const metaThemeColor = document.querySelector('meta[name=theme-color]');
            metaThemeColor.setAttribute('content', color);
        }

        setupTheme();


    </script>


    <script>
        async function translateTexts(texts) {
            const selectedLanguage = localStorage.getItem("selectedLanguage") || "en";
            const response = await fetch(
                `https://translation.googleapis.com/language/translate/v2?key=AIzaSyBkuxn-RDRAwrRKWbyl4Ef4m05aklyhSpA`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        q: texts,
                        target: selectedLanguage,
                    }),
                }
            );

            if (response.ok) {
                const data = await response.json();
                return data.data.translations.map((translation) => translation.translatedText);
            } else {
                // console.error("Error translating text:", response.statusText);
                return texts; // Fallback to original texts
            }
        }

        async function revealText(elementId, text, delay) {
            const element = document.getElementById(elementId);
            let index = 0;

            function addCharacter() {
                element.textContent += text[index++];
                if (index < text.length) {
                    setTimeout(addCharacter, delay);
                } else {
                    element.style.width = "auto";
                }
            }
            addCharacter();
        }

        async function translateAndRevealTexts() {
            // List of texts to translate
            const texts = ["Title", "Logo", "Text", "Select Category"];

            // Translate all texts at once
            const translatedTexts = await translateTexts(texts);

            // Now call revealText for each translated text
            revealText("label-title", translatedTexts[0], 500);
            revealText("label-icon", translatedTexts[1], 500);
            revealText("label-text", translatedTexts[2], 500);
            revealText("label-content-type", translatedTexts[3], 500);
        }

        // Start the translation and reveal process
        translateAndRevealTexts();
    </script>



    <script>

        var firstTextEntered = false;

        function execCommand(command) {
            document.execCommand(command);
        }

        function insertLink() {
            var url = prompt("Enter the URL:");
            if (url) {
                document.execCommand("createLink", false, url);
            }
        }

        function changeTextColor(color) {
            document.execCommand('foreColor', false, color);
        }

        function insertImage() {
            var url = prompt("Enter the image URL:");
            if (url) {
                document.execCommand('insertImage', false, url);
            }
        }

        function changeHeading(heading) {
            document.execCommand('formatBlock', false, heading);
        }

        function insertHorizontalRule() {
            document.execCommand('insertHorizontalRule', false, null);
        }

        function undo() {
            document.execCommand('undo');
        }

        function redo() {
            document.execCommand('redo');
        }

        function changeFont(font) {
            document.execCommand('fontName', false, font);
        }

        function checkFirstText() {
            if (!firstTextEntered) {
                var editor = document.getElementById('editor');
                var firstChild = editor.firstChild;
                if (firstChild && firstChild.nodeType === Node.TEXT_NODE && firstChild.textContent.trim() !== "") {
                    document.execCommand('formatBlock', false, 'h1');
                    firstTextEntered = true;
                }
            }
        }

        function changeTextSize(size) {
            document.execCommand('fontSize', false, size);
        }

        function handleCoverPhoto(event) {
            var file = null;
            var reader = new FileReader();
            if (event.target.files && event.target.files.length > 0) {
                file = event.target.files[0];
                reader.onload = function (event) {
                    var imageUrl = event.target.result;
                    document.getElementById('cover-preview').innerHTML = '<img src="' + imageUrl + '" alt="Cover Photo">';
                    document.getElementById('book-cover').setAttribute('data-url', imageUrl);
                };
                reader.readAsDataURL(file);
            }
        }


        async function translateText(text) {
            const selectedLanguage = localStorage.getItem("selectedLanguage") || "en";
            const response = await fetch(
                `https://translation.googleapis.com/language/translate/v2?key=AIzaSyBkuxn-RDRAwrRKWbyl4Ef4m05aklyhSpA`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        q: text,
                        target: selectedLanguage,
                    }),
                }
            );

            if (response.ok) {
                const data = await response.json();
                return data.data.translations[0].translatedText;
            } else {
                // console.error("Error translating text:", response.statusText);
                return text; // Fallback to original text if translation fails
            }
        }


        async function preview() {
            var title = document.getElementById('book-title').textContent;
            var text = document.getElementById('editor').innerHTML;
            var icon = document.getElementById('book-cover').getAttribute('data-url');
            const contentTypeSelector = document.querySelector('#book-content-type');

            // Translate alert messages before showing them
            const translatedTitleAlert = await translateText("Please Add Title !");
            const translatedTextAlert = await translateText("Please Add Text !");
            const translatedIconAlert = await translateText("Please Add Logo !");

            // Basic validation with translated alert messages
            if (!title.trim()) {
                alert(translatedTitleAlert);
                return;
            }
            if (!text.trim()) {
                alert(translatedTextAlert);
                return;
            }
            if (!icon) {
                alert(translatedIconAlert);
                return;
            }

            // Prepare data and open preview as before
            const data = {
                title: title.trim(),
                text: text.trim(),
                icon: icon,
                name: window.userName,
                content_type: contentTypeSelector.value
            };

            sessionStorage.setItem('data', JSON.stringify(data));
            const previewPageUrl = `reader?action=preview`;
            window.open(previewPageUrl);
        }

    </script>


    <script type="module">



        window.userName = 'Your Name';

        import { auth, signOut, db, collection, query, where, getDocs, doc, getDoc } from './firebase.js';
        const booksCollectionRef = collection(db, 'books');


        const booksGridContainer = document.querySelector('.grid-container');
        const signOutButton = document.querySelector('.sign-out-button');
        signOutButton.style.display = 'none'



        fetchContentTypeList();


        async function fetchContentTypeList() {

            try {
                const response = await fetch('contentTypeList.json');
                if (!response.ok) {
                    throw new Error('Failed to load content types.');
                }
                const data = await response.json();
                const contentTypes = data.content_type_list;
                contentTypes.sort((a, b) => a.localeCompare(b));
                const selectElement = document.querySelector('#book-content-type');
                contentTypes.forEach((contentType) => {
                    const option = document.createElement('option');
                    option.textContent = contentType;
                    selectElement.appendChild(option);
                });


            } catch (error) {
                console.error('Error loading content types:', error);
            }

        }


        async function fetchContentTypeListOld() {

            try {
                const appDataRef = doc(db, 'appData', 'commonAppData');
                const docSnapshot = await getDoc(appDataRef);

                if (docSnapshot.exists()) {
                    const contentTypes = docSnapshot.data().content_type_list;
                    contentTypes.sort((a, b) => a.localeCompare(b));
                    const selectElement = document.querySelector('#book-content-type');
                    contentTypes.forEach((contentType) => {
                        const option = document.createElement('option');
                        option.textContent = contentType;
                        selectElement.appendChild(option);
                    });
                } else {
                    console.error('No such document found.');
                }
            } catch (error) {
                console.error('Error fetching content types. Please try again later' + error);
            } finally {
                // showProgressBar(false);
            }
        }


        auth.onAuthStateChanged(user => {

            if (user) {
                const isGoogleLogin = user.providerData.some(provider => provider.providerId === 'google.com');
                if (isGoogleLogin) {
                    console.log('User is signed in:');
                    window.userName = user.displayName
                    signOutButton.style.display = 'block'
                    signOutButton.addEventListener('click', () => {
                        signOut(auth)
                            .then(() => {
                                console.log('User signed out successfully');
                                window.location.replace('index.html');
                            })
                            .catch((error) => {
                                console.error('Error signing out user:', error);
                            });
                    });

                    fetchBooks(user.uid)
                }
            } else {
                console.log('No user is signed in.');
            }
        });



        async function fetchBooks(userId) {
            try {
                const q = query(booksCollectionRef, where("userId", "==", userId));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    console.log('No books found for this user.');
                    return;
                }


                const sortedDocs = snapshot.docs
                    .map(doc => ({ id: doc.id, data: doc.data() }))
                    .sort((a, b) => b.data.created_at - a.data.created_at);


                sortedDocs.forEach(({ data, id }) => {
                    const card = createCard(data);
                    card.addEventListener('click', () => {
                        showDetail(data, id);
                    });
                    booksGridContainer.appendChild(card);
                });

            } catch (error) {
                console.error('Error fetching books for the user:', error);
            }
        }


        function createCard(data) {
            const image = createElementWithClass('img', 'book-image', {
                src: data.icon,
                alt: data.title,
                width: '100',
                height: '115'
            });


            let status = ''
            if (data.in_review) {
                status = ' ( In Review ) ';
            }

            const imageContainer = createElementWithClass('div', 'image-container', {}, [image]);

            const title = createElementWithClass('h2', 'title', {
                textContent: data.title || 'Title'
            });
            const category = createElementWithClass('h5', 'category', {
                textContent: data.content_type + status || 'New' + status
            });

            const bells = createElementWithClass('h5', 'bells', {
                textContent: `🔔 ${data.bells || '0'}`
            });

            const textContainer = createElementWithClass('div', 'text-container', {}, [title, category, bells]);

            return createElementWithClass('div', 'card', {}, [imageContainer, textContainer]);
        }

        function createElementWithClass(elementType, className, attributes = {}, children = []) {
            const element = document.createElement(elementType);
            element.classList.add(className);
            Object.entries(attributes).forEach(([key, value]) => element[key] = value);
            children.forEach(child => element.appendChild(child));
            return element;
        }



        function showDetail(data, docId) {
            sessionStorage.setItem('data', JSON.stringify(data));
            let titleForUrl = data.title.replace(/[\W_]+/g, '-');
            const readerPageUrl = `reader?title=${titleForUrl}&id=${docId}`;
            window.open(readerPageUrl);
        }

    </script>

</body>

</html>