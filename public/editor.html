<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Website Info  -->
    <title>Article Editor</title>
    <meta name="author" content="manyantra.com">
    <meta name="description"
        content="Article Editor is your intelligent writing companion for creating, editing, and refining content with ease. Whether you're crafting blog posts, essays, reports, or online articles, this powerful AI editor tool helps you write smarter and faster">
    <meta name="keywords"
        content="article editor, content editor, AI editor, grammar checker, blog editor, writing tool, online editor, text editor, spell checker, article writer, writing assistant, content creation, essay editor, proofreading tool, SEO editor, smart writing tool">
    <!-- Website Sharable Link Info  -->
    <meta property="og:title" content="Article Editor">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.manyantra.com/editor">
    <meta property="og:image" content="https://www.manyantra.com/app_cover.png">
    <meta property="og:description"
        content="Article Editor is your intelligent writing companion for creating, editing, and refining content with ease. Whether you're crafting blog posts, essays, reports, or online articles, this powerful AI editor tool helps you write smarter and faster">

    <!-- Website Favicon Icon -->
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="editor.css">



</head>

<body>


    <div class="editor-container">

        <!-- title -->
        <div class="editor-section">
            <label for="book-title" class="editor-label" id="label-title"></label>
            <div class="editor-title" contenteditable="true" id="book-title"></div>
        </div>


        <!-- text -->
        <div class="editor-section">
            <label for="editor" class="editor-label" id="label-text" style="cursor: pointer;"></label>

            <div class="editor-text-container">

                <!-- Actual editor area -->
                <div class="editor-text" contenteditable="true" id="editor" onkeyup="checkFirstText()"></div>
                <!-- Formatting toolbar embedded inside editor -->
                <div class="format-buttons-inline">
                    <input type="color" onchange="changeTextColor(this.value)">
                    <select onchange="changeHeading(this.value)">
                        <option value="h1">Heading 1</option>
                        <option value="h2">Heading 2</option>
                        <option value="h3">Heading 3</option>
                    </select>
                    <select onchange="changeTextSize(this.value)">
                        <option value="2">Normal</option>
                        <option value="1">Small</option>
                        <option value="3">Large</option>
                    </select>
                    <select onchange="changeFont(this.value)">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Georgia">Georgia</option>
                    </select>
                    <button onclick="execCommand('bold')"><b>B</b></button>
                    <button onclick="execCommand('italic')"><i>I</i></button>
                    <button onclick="execCommand('underline')"><u>U</u></button>
                    <button onclick="execCommand('justifyLeft')">Left</button>
                    <button onclick="execCommand('justifyCenter')">Center</button>
                    <button onclick="execCommand('justifyRight')">Right</button>
                    <button onclick="execCommand('insertOrderedList')">OL</button>
                    <button onclick="execCommand('insertUnorderedList')">UL</button>
                    <button onclick="insertLink()">Link</button>
                    <button onclick="insertImage()">Image</button>
                    <button onclick="insertHorizontalRule()">Line</button>
                    <button onclick="undo()">â†©</button>
                    <button onclick="redo()">â†ª</button>
                </div>

            </div>
        </div>


        <!-- icon -->
        <div class="editor-section">
            <label for="book-cover" class="editor-label" id="label-icon"></label>
            <input type="file" id="book-cover" accept="image/*" onchange="handleCoverPhoto(event)">
            <div class="editor-preview" id="cover-preview"></div>
        </div>


        <!-- content_type -->
        <div class="editor-section">
            <label for="book-content-type" class="editor-label" id="label-content-type"></label>
            <select id="book-content-type">
                <option value="New">New</option>
            </select>
        </div>

        <button class="preview-button" onclick="preview()">Preview</button>


    </div>

    <div id="booksGrid" class="grid-container"></div>



    <script>
        async function translateTexts(texts) {
            const selectedLanguage = localStorage.getItem("selectedLanguage") || "en";
            const response = await fetch(
                `https://translation.googleapis.com/language/translate/v2?key=AIzaSyBkuxn-RDRAwrRKWbyl4Ef4m05aklyhSpA`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        q: texts,
                        target: selectedLanguage,
                    }),
                }
            );

            if (response.ok) {
                const data = await response.json();
                return data.data.translations.map((translation) => translation.translatedText);
            } else {
                // console.error("Error translating text:", response.statusText);
                return texts; // Fallback to original texts
            }
        }

        async function revealText(elementId, text, delay) {
            const element = document.getElementById(elementId);
            let index = 0;

            function addCharacter() {
                element.textContent += text[index++];
                if (index < text.length) {
                    setTimeout(addCharacter, delay);
                } else {
                    element.style.width = "auto";
                }
            }
            addCharacter();
        }

        async function translateAndRevealTexts() {
            // List of texts to translate
            const texts = ["Title", "Logo", "Text - Click here to write with AI ðŸ‘ˆ", "Select Category"];

            // Translate all texts at once
            const translatedTexts = await translateTexts(texts);

            // Now call revealText for each translated text
            revealText("label-title", translatedTexts[0], 50);
            revealText("label-icon", translatedTexts[1], 50);
            revealText("label-text", translatedTexts[2], 50);
            revealText("label-content-type", translatedTexts[3], 50);
        }

        // Start the translation and reveal process
        translateAndRevealTexts();
    </script>



    <script>


        var firstTextEntered = false;

        function execCommand(command) {
            document.execCommand(command);
        }

        function insertLink() {
            var url = prompt("Enter the URL:");
            if (url) {
                document.execCommand("createLink", false, url);
            }
        }

        function changeTextColor(color) {
            document.execCommand('foreColor', false, color);
        }

        function insertImage() {
            var url = prompt("Enter the image URL:");
            if (url) {
                document.execCommand('insertImage', false, url);
            }
        }

        function changeHeading(heading) {
            document.execCommand('formatBlock', false, heading);
        }

        function insertHorizontalRule() {
            document.execCommand('insertHorizontalRule', false, null);
        }

        function undo() {
            document.execCommand('undo');
        }

        function redo() {
            document.execCommand('redo');
        }

        function changeFont(font) {
            document.execCommand('fontName', false, font);
        }

        function checkFirstText() {
            if (!firstTextEntered) {
                var editor = document.getElementById('editor');
                var firstChild = editor.firstChild;
                if (firstChild && firstChild.nodeType === Node.TEXT_NODE && firstChild.textContent.trim() !== "") {
                    document.execCommand('formatBlock', false, 'h1');
                    firstTextEntered = true;
                }
            }
        }

        function changeTextSize(size) {
            document.execCommand('fontSize', false, size);
        }

        function handleCoverPhoto(event) {
            var file = null;
            var reader = new FileReader();
            if (event.target.files && event.target.files.length > 0) {
                file = event.target.files[0];
                reader.onload = function (event) {
                    var imageUrl = event.target.result;
                    document.getElementById('cover-preview').innerHTML = '<img src="' + imageUrl + '" alt="Cover Photo">';
                    document.getElementById('book-cover').setAttribute('data-url', imageUrl);
                };
                reader.readAsDataURL(file);
            }
        }


        async function translateText(text) {
            const selectedLanguage = localStorage.getItem("selectedLanguage") || "en";
            const response = await fetch(
                `https://translation.googleapis.com/language/translate/v2?key=AIzaSyBkuxn-RDRAwrRKWbyl4Ef4m05aklyhSpA`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        q: text,
                        target: selectedLanguage,
                    }),
                }
            );

            if (response.ok) {
                const data = await response.json();
                return data.data.translations[0].translatedText;
            } else {
                // console.error("Error translating text:", response.statusText);
                return text; // Fallback to original text if translation fails
            }
        }

        function showCustomAlert(message, onClose) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 9999;
    `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
        background: white; padding: 20px; border-radius: 10px; width: 280px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); text-align: center;
    `;

            const msg = document.createElement('p');
            msg.textContent = message;
            msg.style.marginBottom = '20px';

            const okBtn = document.createElement('button');
            okBtn.textContent = 'OK';
            okBtn.style.cssText = `
        padding: 8px 16px; border: none; border-radius: 6px;
        background: #445F87; color: white; cursor: pointer;
    `;

            okBtn.onclick = () => {
                overlay.remove();
                if (onClose) onClose();
            };

            dialog.appendChild(msg);
            dialog.appendChild(okBtn);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
        }




        async function preview() {


            var title = document.getElementById('book-title').textContent;
            var text = document.getElementById('editor').innerHTML;
            var icon = document.getElementById('book-cover').getAttribute('data-url');
            const contentTypeSelector = document.querySelector('#book-content-type');



            // Translate alert messages before showing them
            const translatedTitleAlert = await translateText("Please Add Title !");
            const translatedTextAlert = await translateText("Please Add Text !");
            const translatedIconAlert = await translateText("Please Add Logo !");

            // Basic validation with translated alert messages
            if (!title.trim()) {
                showCustomAlert(translatedTitleAlert);
                return;
            }
            if (!text.trim()) {
                showCustomAlert(translatedTextAlert);
                return;
            }
            if (!icon) {
                showCustomAlert(translatedIconAlert);
                return;
            }

            // Prepare data and open preview as before
            const data = {
                title: title.trim(),
                text: text.trim(),
                icon: icon,
                name: window.userName,
                content_type: contentTypeSelector.value
            };

            sessionStorage.setItem('data', JSON.stringify(data));
            const previewPageUrl = `reader?action=preview`;
            window.open(previewPageUrl);
        }



    </script>




    <script type="module">


        import { auth, db, collection, query, where, getDocs, deleteDoc, doc, getDoc } from './firebase.js';
        const booksCollectionRef = collection(db, 'books');
        const booksGridContainer = document.querySelector('.grid-container');



        import { streamGenerateText } from "./assistant-helper.js";
        const labelTextEl = document.getElementById("label-text");
        const editorEl = document.getElementById("editor");
        const titleEl = document.getElementById("book-title");


        async function fetchImageByTitle(title) {
            // https://pixabay.com/api/docs/ - get your own key, do not use it please.
            const url = `https://pixabay.com/api/?key=49657160-a152b5ae10e5ac6c6af772a3f&q=${encodeURIComponent(title)}&image_type=photo&orientation=vertical`;
            const res = await fetch(url);
            const data = await res.json();

            if (data.hits && data.hits.length > 0) {
                // return data.hits[0].webformatURL; // Or largeImageURL for higher res
                return data.hits[0].previewURL; // ~150px thumbnail (closest to 100x100)
            } else {
                throw new Error("No image found for this title.");
            }
        }


        async function translateText(text) {
            const selectedLanguage = localStorage.getItem("selectedLanguage") || "en";
            const response = await fetch(
                `https://translation.googleapis.com/language/translate/v2?key=AIzaSyBkuxn-RDRAwrRKWbyl4Ef4m05aklyhSpA`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        q: text,
                        target: selectedLanguage,
                    }),
                }
            );

            if (response.ok) {
                const data = await response.json();
                return data.data.translations[0].translatedText;
            } else {
                // console.error("Error translating text:", response.statusText);
                return text; // Fallback to original text if translation fails
            }
        }

        labelTextEl.addEventListener("click", async () => {
            const title = titleEl.innerText.trim();
            if (!title) {
                const translatedTextAlert = await translateText("Please enter a title first.");
                showCustomAlert(translatedTextAlert);
                return;
            }

            const prompt = `Write an article about: ${title}`;

            // const selectedLanguage = localStorage.getItem('selectedLanguage') || 'en';
            // const prompt = `Write an article about: "${title}" in this language code "${selectedLanguage}". Use the tone of a professional writer.`;


            editorEl.innerHTML = "";
            editorEl.classList.add("loading");

            await streamGenerateText(prompt, (htmlChunk) => {
                const wrapper = document.createElement("div");
                wrapper.innerHTML = htmlChunk;
                editorEl.appendChild(wrapper);
                editorEl.scrollTop = editorEl.scrollHeight;
            });

            // Fetch and apply image
            try {
                const imageUrl = await fetchImageByTitle(title);
                document.getElementById('cover-preview').innerHTML = `<img src="${imageUrl}" alt="Cover Photo">`;
                document.getElementById('book-cover').setAttribute('data-url', imageUrl);
            } catch (error) {
                console.error("Could not fetch cover image:", error);
            }

            editorEl.classList.remove("loading");


        });


        fetchContentTypeList();
        async function fetchContentTypeList() {

            try {
                const response = await fetch('contentTypeList.json');
                if (!response.ok) {
                    throw new Error('Failed to load content types.');
                }
                const data = await response.json();
                const contentTypes = data.content_type_list;
                contentTypes.sort((a, b) => a.localeCompare(b));
                const selectElement = document.querySelector('#book-content-type');
                contentTypes.forEach((contentType) => {
                    const option = document.createElement('option');
                    option.textContent = contentType;
                    selectElement.appendChild(option);
                });


            } catch (error) {
                console.error('Error loading content types:', error);
            }

        }


        fetchBooks();
        async function fetchBooks() {
            try {
                const q = query(booksCollectionRef, where("userId", "==", localStorage.getItem('uid')));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    console.log('No books found for this user.');
                    return;
                }

                const sortedDocs = snapshot.docs
                    .map(doc => ({ id: doc.id, data: doc.data() }))
                    .sort((a, b) => b.data.created_at - a.data.created_at);

                sortedDocs.forEach(({ data, id }) => {
                    const card = createCard(data, id);
                    card.addEventListener('click', () => {
                        showDetail(data, id);
                    });
                    booksGridContainer.appendChild(card);
                });

            } catch (error) {
                console.error('Error fetching books for the user:', error);
            }
        }

        function createCard(data, id) {
            const image = createElementWithClass('img', 'book-image', {
                src: data.icon,
                alt: data.title,
                width: '100',
                height: '115'
            });

            let status = '';
            if (data.in_review) {
                status = ' ( In Review ) ';
            }

            const imageContainer = createElementWithClass('div', 'image-container', {}, [image]);

            const title = createElementWithClass('h2', 'title', {
                textContent: data.title || 'Title'
            });
            const category = createElementWithClass('h5', 'category', {
                textContent: (data.content_type || 'New') + status
            });
            const bells = createElementWithClass('h5', 'bells', {
                textContent: `ðŸ”” ${data.bells || '0'}`
            });

            const deleteButton = createElementWithClass('button', 'delete-button', {
                textContent: 'Delete'
            });

            const cardElement = createElementWithClass('div', 'card', {}, [imageContainer]);

            const textContainer = createElementWithClass('div', 'text-container', {}, [title, category, bells, deleteButton]);
            cardElement.appendChild(textContainer);

            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteDialog({
                    message: 'Are you sure, want to delete this Article ?',
                    onDelete: async () => {
                        try {
                            await deleteDoc(doc(booksCollectionRef, id));
                            cardElement.remove();
                        } catch (error) {
                            console.error('Error deleting book:', error);
                        }
                    }
                });
            });

            return cardElement;
        }


        function createElementWithClass(elementType, className, attributes = {}, children = []) {
            const element = document.createElement(elementType);
            element.classList.add(className);
            Object.entries(attributes).forEach(([key, value]) => element[key] = value);
            children.forEach(child => element.appendChild(child));
            return element;
        }

        function showCustomAlert(message, onClose) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 9999;
    `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
        background: white; padding: 20px; border-radius: 10px; width: 280px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); text-align: center;
    `;

            const msg = document.createElement('p');
            msg.textContent = message;
            msg.style.marginBottom = '20px';

            const okBtn = document.createElement('button');
            okBtn.textContent = 'OK';
            okBtn.style.cssText = `
        padding: 8px 16px; border: none; border-radius: 6px;
        background: #007bff; color: white; cursor: pointer;
    `;

            okBtn.onclick = () => {
                overlay.remove();
                if (onClose) onClose();
            };

            dialog.appendChild(msg);
            dialog.appendChild(okBtn);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
        }


        function showDeleteDialog({ onDelete, onCancel }) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 9999;
    `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
        background: white; padding: 20px; border-radius: 10px; width: 220px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); text-align: center;
    `;

            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.cssText = `
        display: flex; justify-content: space-between;
    `;

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.cssText = `
        flex: 1; margin-right: 10px; padding: 8px 0;
        border: none; border-radius: 6px; background: #ccc; cursor: pointer;
    `;

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.style.cssText = `
        flex: 1; padding: 8px 0;
        border: none; border-radius: 6px; background: #ff5c5c; color: white; cursor: pointer;
    `;

            cancelBtn.onclick = () => {
                overlay.remove();
                onCancel && onCancel();
            };

            deleteBtn.onclick = () => {
                overlay.remove();
                onDelete && onDelete();
            };

            buttonsContainer.appendChild(cancelBtn);
            buttonsContainer.appendChild(deleteBtn);
            dialog.appendChild(buttonsContainer);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
        }


        function showDetail(data, docId) {
            sessionStorage.setItem('data', JSON.stringify(data));
            let titleForUrl = data.title.replace(/[\W_]+/g, '-');
            const readerPageUrl = `reader?title=${titleForUrl}&id=${docId}`;
            window.open(readerPageUrl);
        }

    </script>



</body>

</html>